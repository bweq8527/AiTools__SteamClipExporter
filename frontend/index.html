<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Steam 录像自动化转换工具</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* 这里直接放入原本 style.css 的内容 */
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        #clipListContainer { max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; }
        .clip-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .clip-item:hover { background: #f0f0f0; }
        .clip-item.selected { background: #e3f2fd; border-left: 5px solid #1e88e5; }
        .clip-item.converted { background: #e8f5e9; color: #888; cursor: default; }
        #queueContainer div { padding: 10px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .running { background: #e3f2fd; }
        progress { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Steam 录像转换控制台</h1>
        <div class="section">
            <h2>1. 设置录像根目录</h2>
            <input type="text" id="clipPath" style="width:70%; padding:8px;" placeholder="例如: H:\录屏工作目录\Steam">
            <button onclick="setPathAndLoad()" style="padding:8px 15px;">设置路径并扫描</button>
            <p id="pathStatus"></p>
        </div>
        <div class="main-content">
            <div class="section">
                <h2>2. 待转换列表</h2>
                <div id="clipListContainer"></div>
                <button onclick="addToQueue()" id="queueBtn" disabled>加入转换队列</button>
            </div>
            <div class="section">
                <h2>3. 队列进度</h2>
                <div id="queueContainer"></div>
            </div>
            <div class="section" style="grid-column: 1/3;">
                <canvas id="progressChart" style="height:200px;"></canvas>
            </div>
        </div>
    </div>

    <script>
        /* 这里直接放入原本 script.js 的内容 */
        const API_BASE = '/api';
        let selectedClips = [];
        let progressChart = null;

        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'bar', data: { labels: [], datasets: [{ label: '进度 (%)', data: [], backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
                options: { indexAxis: 'y', scales: { x: { max: 100, min: 0 } } }
            });
        }

        async function setPathAndLoad() {
            const path = document.getElementById('clipPath').value;
            try {
                const res = await axios.post(`${API_BASE}/set_path`, { path });
                document.getElementById('pathStatus').innerText = "✅ " + res.data.message;
                await loadClipList();
                setInterval(updateProgress, 1000);
            } catch (e) { alert("路径设置失败"); }
        }

        async function loadClipList() {
            const res = await axios.get(`${API_BASE}/clips`);
            const container = document.getElementById('clipListContainer');
            container.innerHTML = '';
            res.data.clips.forEach(clip => {
                const div = document.createElement('div');
                div.className = 'clip-item' + (clip.is_converted ? ' converted' : '');
                div.innerText = (clip.is_converted ? '[已转换] ' : '') + clip.name;
                if (!clip.is_converted) div.onclick = () => {
                    div.classList.toggle('selected');
                    const idx = selectedClips.indexOf(clip.id);
                    if (idx > -1) selectedClips.splice(idx, 1); else selectedClips.push(clip.id);
                };
                container.appendChild(div);
            });
            document.getElementById('queueBtn').disabled = false;
        }

        async function addToQueue() {
            await axios.post(`${API_BASE}/queue`, { clip_ids: selectedClips });
            selectedClips = [];
            loadClipList();
        }

        async function updateProgress() {
            const res = await axios.get(`${API_BASE}/progress`);
            const statuses = res.data.all_statuses;
            const qContainer = document.getElementById('queueContainer');
            qContainer.innerHTML = '';
            const labels = [], data = [];
            for (let id in statuses) {
                if (statuses[id].status === 'running' || statuses[id].status === 'pending') {
                    labels.push(id);
                    data.push(statuses[id].progress);
                    qContainer.innerHTML += `<div class="${statuses[id].status}"><strong>${id}</strong>: ${statuses[id].progress}%</div>`;
                }
            }
            progressChart.data.labels = labels;
            progressChart.data.datasets[0].data = data;
            progressChart.update();
        }
        document.addEventListener('DOMContentLoaded', initChart);
    </script>
</body>
</html>